<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Board</title>
  <!-- Favicon -->
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  
  <!-- External CSS -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="card">
      <h1 id="studentName">Nuno's Task Board</h1>
      <p id="currentDate">Tuesday, March 16</p>
    </header>
    
    <!-- Archive Toggle Button -->
    <button class="archive-toggle" id="archiveToggle">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="16" y1="2" x2="16" y2="6"></line>
        <line x1="8" y1="2" x2="8" y2="6"></line>
        <line x1="3" y1="10" x2="21" y2="10"></line>
      </svg>
      <span>Show Archive</span> (<span id="archiveCount">2</span>)
    </button>
    
    <!-- Archive Container (Hidden by Default) -->
    <div class="card archive-container hidden" id="archiveContainer">
      <div class="section-title">Archived Tasks</div>
      <div id="archiveTasks">
        <!-- Archive tasks will be dynamically added here -->
      </div>
      <div id="emptyArchive" class="empty-state">No archived tasks</div>
    </div>
    
    <!-- Tomorrow's Classes Card -->
    <div class="card">
      <div class="section-title">TOMORROW'S CLASSES</div>
      <div class="subject-list" id="tomorrowClasses">
        <!-- Tomorrow's classes will be dynamically loaded here -->
      </div>
      
      <div class="tasks-section">
        <h3>Tasks To Complete:</h3>
        <div id="currentTasks">
          <!-- Current tasks will be dynamically loaded here -->
        </div>
        <div id="emptyCurrentTasks" class="empty-state">No tasks for tomorrow's classes</div>
      </div>
    </div>
    
    <!-- Upcoming Tasks Card -->
    <div class="card">
      <div class="section-title">Upcoming Tasks</div>
      <div id="futureTasks">
        <!-- Future tasks will be dynamically loaded here -->
      </div>
      <div id="emptyFutureTasks" class="empty-state">No upcoming tasks</div>
    </div>
  </div>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  
  <script type="module">
    import { 
      getTodayFinDate, 
      parseFinDate, 
      isToday, 
      isTomorrow, 
      determineTaskContainer,
      hasClassTodayOrTomorrow,
      getDayName,
      formatFinDate
    } from './src/utils/dateUtils.js';
    
    import { waitForFirebase, getFirestore } from './src/services/firebaseService.js';
    
    // Import the centralized task categorization service
    import { categorizeTasksByBusinessRules } from './src/services/taskCategorization.js';
    
    // Initialize Firebase using the centralized service
    let db;
    
    // DOM Elements
    const elements = {
      studentName: document.getElementById('studentName'),
      currentDate: document.getElementById('currentDate'),
      archiveToggle: document.getElementById('archiveToggle'),
      archiveContainer: document.getElementById('archiveContainer'),
      archiveCount: document.getElementById('archiveCount'),
      archiveTasks: document.getElementById('archiveTasks'),
      emptyArchive: document.getElementById('emptyArchive'),
      tomorrowClasses: document.getElementById('tomorrowClasses'),
      currentTasks: document.getElementById('currentTasks'),
      emptyCurrentTasks: document.getElementById('emptyCurrentTasks'),
      futureTasks: document.getElementById('futureTasks'),
      emptyFutureTasks: document.getElementById('emptyFutureTasks')
    };
    
    // Subject colors mapping
    const subjectColors = {
      'math': 'var(--subject-math)',
      'finnish': 'var(--subject-finnish)',
      'english': 'var(--subject-english)',
      'history': 'var(--subject-history)',
      'civics': 'var(--subject-civics)',
      'ethics': 'var(--subject-ethics)',
      'pe': 'var(--subject-pe)',
      'music': 'var(--subject-music)',
      'art': 'var(--subject-art)',
      'crafts': 'var(--subject-crafts)',
      'eco': 'var(--subject-eco)',
      'digi': 'var(--subject-digi)'
    };
    
    // Schedule data
    const schedule = {
      'Monday': ['Math', 'Eco', 'Crafts', 'PE'],
      'Tuesday': ['Math', 'Finnish', 'History', 'Music', 'PE'],
      'Wednesday': ['Finnish', 'Math', 'English', 'Ethics', 'PE'],
      'Thursday': ['English', 'Math', 'Eco', 'Finnish'],
      'Friday': ['Art', 'Civics', 'Finnish', 'Digi'],
      'Saturday': [],
      'Sunday': []
    };
    
    // Format date to display
    function formatDateDisplay() {
      const today = new Date();
      const options = { weekday: 'long', month: 'long', day: 'numeric' };
      elements.currentDate.textContent = today.toLocaleDateString('en-US', options);
    }
    
    // Format date for task cards
    function formatDate(dateString) {
      if (!dateString) return 'No due date';
      
      const date = parseFinDate(dateString);
      const options = { month: 'short', day: 'numeric' };
      return date.toLocaleDateString('en-US', options);
    }
    
    // Get appropriate label for due date
    function getDueLabel(dateString) {
      if (!dateString) return '';
      
      if (isToday(dateString)) {
        return '<span class="badge badge-today">Today</span>';
      } else if (isTomorrow(dateString)) {
        return '<span class="badge badge-tomorrow">Tomorrow</span>';
      }
      return '';
    }
    
    // Load tomorrow's classes
    function loadTomorrowClasses() {
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(today.getDate() + 1);
      const tomorrowName = getDayName(tomorrow);
      
      const tomorrowSubjects = schedule[tomorrowName] || [];
      
      if (tomorrowSubjects.length === 0) {
        elements.tomorrowClasses.innerHTML = '<div class="empty-state">No classes tomorrow</div>';
        return;
      }
      
      elements.tomorrowClasses.innerHTML = '';
      tomorrowSubjects.forEach(subject => {
        const subjectKey = subject.toLowerCase();
        const color = subjectColors[subjectKey] || 'var(--text-primary)';
        
        const subjectPill = document.createElement('div');
        subjectPill.className = 'subject-pill';
        subjectPill.textContent = subject;
        subjectPill.style.backgroundColor = color;
        
        elements.tomorrowClasses.appendChild(subjectPill);
      });
    }
    
    // Create task card element
    function createTaskCard(task) {
      const { id, subject, description, date, dueDate, completed } = task;
      
      const subjectKey = subject ? subject.toLowerCase() : 'other';
      const color = subjectColors[subjectKey] || 'var(--text-primary)';
      
      const taskCard = document.createElement('div');
      taskCard.className = `card task-card subject-${subjectKey}`;
      if (completed) {
        taskCard.classList.add('completed-task');
      }
      
      taskCard.innerHTML = `
        <div class="header">
          <div class="subject-badge ${subjectKey}">${subject || 'Other'}</div>
          <button class="complete-btn" data-task-id="${id}" ${completed ? 'disabled' : ''}>âœ“</button>
        </div>
        <div class="description">${description}</div>
        <div class="task-meta">
          <span>Created: ${formatDate(date)}</span>
          ${dueDate ? `<span>Due: ${formatDate(dueDate)}</span>` : ''}
        </div>
      `;
      
      // Add event listener for complete button
      const completeBtn = taskCard.querySelector('.complete-btn');
      if (completeBtn && !completed) {
        completeBtn.addEventListener('click', () => {
          markTaskComplete(id);
        });
      }
      
      return taskCard;
    }
    
    // Mark task as complete
    async function markTaskComplete(taskId) {
      try {
        console.log('Marking task as complete:', taskId);
        
        // Get today's date in Finnish format
        const today = getTodayFinDate();
        
        // Update the task in Firestore directly
        await db.collection('tasks').doc(taskId).update({
          completed: true,
          completedDate: today,
          updatedAt: Date.now()
        });
        
        console.log('Task marked as complete in Firestore');
        
        // Refresh tasks after completion
        loadTasks();
      } catch (error) {
        console.error('Error completing task:', error);
      }
    }
    
    // Load and categorize tasks
    async function loadTasks() {
      try {
        const snapshot = await db.collection('tasks').get();
        const tasks = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        // Use the centralized task categorization service
        const { archive: archiveTasks, current: currentTasks, future: futureTasks } = categorizeTasksByBusinessRules(tasks);
        
        // Update archive count
        elements.archiveCount.textContent = archiveTasks.length;
        
        // Render archive tasks
        renderTaskList(elements.archiveTasks, elements.emptyArchive, archiveTasks);
        
        // Render current tasks
        renderTaskList(elements.currentTasks, elements.emptyCurrentTasks, currentTasks);
        
        // Render future tasks
        renderTaskList(elements.futureTasks, elements.emptyFutureTasks, futureTasks);
        
      } catch (error) {
        console.error('Error loading tasks:', error);
      }
    }
    
    // Render a list of tasks to a container
    function renderTaskList(container, emptyElement, tasks) {
      container.innerHTML = '';
      
      if (tasks.length === 0) {
        emptyElement.style.display = 'block';
      } else {
        emptyElement.style.display = 'none';
        
        // Sort tasks by date (ascending)
        tasks.sort((a, b) => {
          if (!a.date) return 1;
          if (!b.date) return -1;
          return parseFinDate(a.date) - parseFinDate(b.date);
        });
        
        tasks.forEach(task => {
          const taskCard = createTaskCard(task);
          container.appendChild(taskCard);
        });
      }
    }
    
    // Initialize app
    async function init() {
      try {
        // Wait for Firebase to be initialized
        const { db: firestore } = await waitForFirebase();
        
        // Set global db for compatibility
        db = firestore;
        
        // Load student name
        db.collection('settings').doc('profile').get()
          .then(doc => {
            if (doc.exists) {
              const { name } = doc.data();
              elements.studentName.textContent = `${name}'s Task Board`;
            }
          })
          .catch(error => console.error('Error loading profile:', error));
        
        // Format date
        formatDateDisplay();
        
        // Load tomorrow's classes
        loadTomorrowClasses();
        
        // Load tasks
        loadTasks();
        
        // Set up event listeners
        elements.archiveToggle.addEventListener('click', () => {
          elements.archiveContainer.classList.toggle('expanded');
          
          const isExpanded = elements.archiveContainer.classList.contains('expanded');
          const toggleText = elements.archiveToggle.querySelector('span');
          toggleText.textContent = isExpanded ? 'Hide Archive' : 'Show Archive';
        });
      } catch (error) {
        console.error('Failed to initialize app:', error);
      }
    }
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>